<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីស្នើសុំប្រាក់កម្ចី</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Kantumruy+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kantumruy Pro', 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
        }
        .khmer-font {
            font-family: 'Kantumruy Pro', sans-serif;
        }
        .container {
            max-width: 700px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: white;
            border-radius: 0.5rem; /* 8px */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        label {
            font-weight: 500;
            color: #374151; /* Gray-700 */
        }
        input[type="text"],
        input[type="date"],
        input[type="tel"],
        input[type="number"],
        input[type="file"],
        textarea {
            width: 100%;
            padding: 0.75rem; /* 12px */
            border: 1px solid #D1D5DB; /* Gray-300 */
            border-radius: 0.375rem; /* 6px */
            margin-top: 0.25rem;
            box-shadow: inset 0 1px 2px 0 rgba(0,0,0,0.05);
        }
        input[type="file"] {
            padding: 0.5rem;
        }
        button {
            background-color: #3B82F6; /* Blue-500 */
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #2563EB; /* Blue-600 */
        }
        button:disabled {
            background-color: #9CA3AF; /* Gray-400 */
            cursor: not-allowed;
        }
        .result-section {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #EFF6FF; /* Blue-50 */
            border: 1px solid #BFDBFE; /* Blue-200 */
            border-radius: 0.375rem;
        }
        .error-message {
            color: #EF4444; /* Red-500 */
            font-size: 0.875rem; /* 14px */
            margin-top: 0.25rem;
        }
        .success-message {
            color: #10B981; /* Green-500 */
            font-size: 0.875rem; /* 14px */
            margin-top: 0.25rem;
        }
        /* Responsive adjustments */
        @media (max-width: 640px) {
            .container {
                margin: 1rem;
                padding: 1rem;
            }
            h1 {
                font-size: 1.5rem; /* 24px */
            }
        }
    </style>
</head>
<body class="khmer-font">
    <div class="container">
        <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-6">
            📝 ពាក្យស្នើសុំប្រាក់កម្ចី
        </h1>

        <form id="loanApplicationForm" class="space-y-6">
            <div>
                <label for="fullName" class="block text-sm">ឈ្មោះពេញ</label>
                <input type="text" id="fullName" name="fullName" placeholder="ឧ. សុខ ចាន់ណា" required class="mt-1">
            </div>

            <div>
                <label for="address" class="block text-sm">អាសយដ្ឋានបច្ចុប្បន្ន</label>
                <textarea id="address" name="address" rows="3" placeholder="ឧ. ផ្ទះលេខ១២៣, ផ្លូវ៤៥៦, សង្កាត់..., ខណ្ឌ..., រាជធានីភ្នំពេញ" required class="mt-1"></textarea>
            </div>

            <div>
                <label for="idCard" class="block text-sm">លេខអត្តសញ្ញាណប័ណ្ណ</label>
                <input type="text" id="idCard" name="idCard" placeholder="ឧ. 123456789" required class="mt-1">
            </div>

            <div>
                <label for="dob" class="block text-sm">ថ្ងៃខែឆ្នាំកំណើត</label>
                <input type="date" id="dob" name="dob" required class="mt-1">
            </div>

            <div>
                <label for="selfie" class="block text-sm">រូបថត Selfie</label>
                <input type="file" id="selfie" name="selfie" accept="image/*" required class="mt-1">
                 <p class="text-xs text-gray-500 mt-1">ចំណាំ៖ មានតែឈ្មោះไฟล์រូបថតប៉ុណ្ណោះដែលនឹងត្រូវបានរក្សាទុក។</p>
            </div>

            <div>
                <label for="phoneNumber" class="block text-sm">លេខទូរស័ព្ទ</label>
                <input type="tel" id="phoneNumber" name="phoneNumber" placeholder="ឧ. 012345678" required pattern="[0-9]{9,10}" class="mt-1">
                <p class="text-xs text-gray-500 mt-1">សូមបញ្ចូលលេខទូរស័ព្ទ ៩ ឬ ១០ ខ្ទង់។</p>
            </div>

            <div>
                <label for="loanAmount" class="block text-sm">ចំនួនប្រាក់កម្ចី (ដុល្លារ)</label>
                <input type="number" id="loanAmount" name="loanAmount" placeholder="ឧ. 1000" required min="1" class="mt-1">
            </div>

            <div>
                <label for="loanDuration" class="block text-sm">រយៈពេលកម្ចី (ខែ)</label>
                <input type="number" id="loanDuration" name="loanDuration" placeholder="ឧ. 12" required min="1" class="mt-1">
            </div>
            
            <div id="messageContainer" class="text-sm"></div>

            <button type="submit" class="w-full">
                គណនា និងបញ្ជូនពាក្យ
            </button>
        </form>

        <div id="resultSection" class="result-section hidden mt-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">លទ្ធផលគណនាបឋម</h2>
            <p class="text-gray-600"><strong>ទឹកប្រាក់សរុបត្រូវបង់៖</strong> <span id="totalAmountToPay" class="font-bold text-blue-600"></span> ដុល្លារ</p>
            <p class="text-gray-600 mt-1"><strong>ការបង់ប្រចាំខែ៖</strong> <span id="monthlyPayment" class="font-bold text-blue-600"></span> ដុល្លារ</p>
            <p class="text-gray-600 mt-1"><strong>ថ្លៃសេវាកម្ចី (កាត់ទុកជាមុន)៖</strong> <span id="loanServiceFee" class="font-bold text-red-600"></span> ដុល្លារ</p>
            <p class="text-gray-600 mt-1"><strong>ទឹកប្រាក់ដែលទទួលបានជាក់ស្តែង៖</strong> <span id="actualReceivedAmount" class="font-bold text-green-600"></span> ដុល្លារ</p>
            <p class="text-xs text-gray-500 mt-3">
                ចំណាំ៖ ទឹកប្រាក់សរុបត្រូវបង់នេះ គឺផ្អែកលើចំនួនទឹកប្រាក់ដែលលោកអ្នកបានស្នើសុំ។ ថ្លៃសេវាកម្ចីត្រូវបានដកចេញមុនពេលលោកអ្នកទទួលបានទឹកប្រាក់កម្ចីជាក់ស្តែង។ សូមទាក់ទងមកកាន់យើងខ្ញុំសម្រាប់ព័ត៌មានលម្អិតអំពីលក្ខខណ្ឌផ្សេងៗ។
            </p>
        </div>
    </div>

    <script>
        // JavaScript for form handling, calculation, and Google Sheets submission
        const loanForm = document.getElementById('loanApplicationForm');
        const resultSection = document.getElementById('resultSection');
        const totalAmountToPayEl = document.getElementById('totalAmountToPay');
        const monthlyPaymentEl = document.getElementById('monthlyPayment');
        const loanServiceFeeEl = document.getElementById('loanServiceFee');
        const actualReceivedAmountEl = document.getElementById('actualReceivedAmount');
        const messageContainer = document.getElementById('messageContainer'); // For errors and success messages

        // --- IMPORTANT: Configure your Google Apps Script Web App URL here ---
        // Replace 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE' with your actual deployed Apps Script URL.
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw1IvwdwDu5pgpJbyeYu4glwL2Bm3HhqnQ7a0VtVHorBjXIovtMCHk7ShxVLUSv59cj/exec';

        // Interest rate per month for calculating the upfront service fee
        const MONTHLY_RATE_FOR_SERVICE_FEE = 0.20; // 20% per month

        // Helper function to format currency
        function formatCurrency(amount) {
            return amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        // Function to display messages
        function showMessage(text, type = 'error') {
            messageContainer.textContent = text;
            if (type === 'error') {
                messageContainer.className = 'error-message text-sm';
            } else if (type === 'success') {
                messageContainer.className = 'success-message text-sm';
            } else {
                 messageContainer.className = 'text-sm text-gray-600'; // Neutral message
            }
        }

        loanForm.addEventListener('submit', async function(event) {
            event.preventDefault(); // Prevent actual form submission

            // Clear previous messages and results
            showMessage('', 'neutral'); // Clear message
            resultSection.classList.add('hidden');
            const submitButton = loanForm.querySelector('button[type="submit"]');

            // Get form values
            const fullName = document.getElementById('fullName').value.trim();
            const address = document.getElementById('address').value.trim();
            const idCard = document.getElementById('idCard').value.trim();
            const dob = document.getElementById('dob').value;
            const selfieInput = document.getElementById('selfie');
            const selfieFile = selfieInput.files[0];
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            const loanAmount = parseFloat(document.getElementById('loanAmount').value);
            const loanDuration = parseInt(document.getElementById('loanDuration').value);

            // Basic Validation
            let errors = [];
            if (!fullName) errors.push("សូមបញ្ចូលឈ្មោះពេញ។");
            if (!address) errors.push("សូមបញ្ចូលអាសយដ្ឋាន។");
            if (!idCard) errors.push("សូមបញ្ចូលលេខអត្តសញ្ញាណប័ណ្ណ។");
            if (!dob) errors.push("សូមបញ្ចូលថ្ងៃខែឆ្នាំកំណើត។");
            if (!selfieFile) errors.push("សូមបញ្ចូលរូបថត Selfie។");
            if (!phoneNumber) {
                errors.push("សូមបញ្ចូលលេខទូរស័ព្ទ។");
            } else if (!/^[0-9]{9,10}$/.test(phoneNumber)) {
                errors.push("លេខទូរស័ព្ទមិនត្រឹមត្រូវ (ត្រូវមាន ៩ ឬ ១០ ខ្ទង់)។");
            }
            if (isNaN(loanAmount) || loanAmount <= 0) {
                errors.push("ចំនួនប្រាក់កម្ចីមិនត្រឹមត្រូវ។");
            }
            if (isNaN(loanDuration) || loanDuration <= 0) {
                errors.push("រយៈពេលកម្ចីមិនត្រឹមត្រូវ។");
            }

            if (errors.length > 0) {
                showMessage(errors.join('\n'), 'error');
                return;
            }

            // --- Calculation ---
            const totalAmountToPay = loanAmount; // Borrower repays the principal requested

            // Calculate upfront service fee
            // This is based on 20% of the loan amount PER MONTH of the loan duration
            const upfrontServiceFeeCalculated = loanAmount * MONTHLY_RATE_FOR_SERVICE_FEE * loanDuration;

            // Calculate actual amount received by the borrower
            const actualReceivedAmountCalculated = loanAmount - upfrontServiceFeeCalculated;

            // Monthly payment is based on the total amount to be paid (principal)
            const monthlyPayment = totalAmountToPay / loanDuration;

            // Check if the service fee is higher than the loan amount
            if (actualReceivedAmountCalculated < 0) {
                showMessage(`ថ្លៃសេវាកម្ចី (${formatCurrency(upfrontServiceFeeCalculated)} ដុល្លារ) គឺខ្ពស់ជាងจำนวนប្រាក់កម្ចីដែលបានស្នើសុំ (${formatCurrency(loanAmount)} ដុល្លារ)។ អ្នកនឹងមិនទទួលបានទឹកប្រាក់ទេ ហើយអាចនឹងជំពាក់បន្ថែម។ សូមពិនិត្យឡើងវិញនូវចំនួនទឹកប្រាក់កម្ចី ឬរយៈពេលកម្ចី។`, 'error');
                resultSection.classList.add('hidden'); // Hide results if this critical error occurs
                return;
            }
            
            // Display results
            totalAmountToPayEl.textContent = formatCurrency(totalAmountToPay);
            monthlyPaymentEl.textContent = formatCurrency(monthlyPayment);
            loanServiceFeeEl.textContent = formatCurrency(upfrontServiceFeeCalculated);
            actualReceivedAmountEl.textContent = formatCurrency(actualReceivedAmountCalculated);
            
            resultSection.classList.remove('hidden');
            showMessage('ការគណនាបានជោគជ័យ។ លទ្ធផលបង្ហាញនៅខាងក្រោម។', 'success');


            // --- Google Sheets Submission ---
            if (GOOGLE_APPS_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE' || !GOOGLE_APPS_SCRIPT_URL) {
                console.warn('Google Apps Script URL is not configured. Data will not be sent to Google Sheets.');
                showMessage('ការគណនាបានជោគជ័យ។ ចំណាំ៖ ការតភ្ជាប់ទៅ Google Sheets មិនទាន់បានរៀបចំទេ។', 'neutral');
                return; // Stop here if URL not configured
            }

            const formDataForSheet = {
                timestamp: new Date().toLocaleString('en-GB', {hour12: false}).replace(',', ''), // More robust timestamp
                fullName,
                address,
                idCard,
                dob,
                selfieName: selfieFile ? selfieFile.name : 'N/A', // Only filename
                phoneNumber,
                requestedLoanAmount: loanAmount,
                loanDuration,
                loanServiceFee: upfrontServiceFeeCalculated,
                actualReceived: actualReceivedAmountCalculated,
                totalToRepay: totalAmountToPay,
                monthlyRepayment: monthlyPayment
            };

            submitButton.disabled = true;
            submitButton.textContent = 'កំពុងបញ្ជូនទិន្នន័យ...';
            showMessage('កំពុងព្យាយាមបញ្ជូនទិន្នន័យទៅ Google Sheets...', 'neutral');

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Client-side cannot read response with 'no-cors'
                    cache: 'no-cache',
                    headers: {
                        // 'Content-Type': 'application/json', // For 'no-cors' this might not be strictly necessary or could be text/plain
                                                            // Apps Script doPost(e) will get data in e.postData.contents
                    },
                    body: JSON.stringify(formDataForSheet) // Apps Script needs to parse this JSON from e.postData.contents
                });
                
                // Since mode is 'no-cors', we can't check response.status. Assume success if fetch doesn't throw.
                console.log('Data submission to Google Sheet initiated (using no-cors).');
                showMessage('ទិន្នន័យត្រូវបានបញ្ជូនទៅ Google Sheets ដោយជោគជ័យ (ការបញ្ជូនត្រូវបានផ្តួចផ្តើម)។', 'success');
                // loanForm.reset(); // Optionally reset the form

            } catch (error) {
                console.error('Error submitting data to Google Sheet:', error);
                showMessage('មានបញ្ហាក្នុងការបញ្ជូនទិន្នន័យទៅ Google Sheets។ សូមពិនិត្យ Console សម្រាប់ព័ត៌មានបន្ថែម។', 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'គណនា និងបញ្ជូនពាក្យ';
            }
        });
    </script>
</body>
</html>
